## Context

`core` 模块中的部分 SQL AST 继承层次在长期演进后出现了职责分散与行为重复：相近节点在父类与子类之间的访问/分发契约不够统一，导致同类重构需要在多处分支重复修正。该问题已开始影响近期 parser/visitor 重构的稳定性与回归成本，因此本次以兼容优先方式收敛继承层次行为契约。

## Goals / Non-Goals

**Goals:**
- 在不改变对外解析结果的前提下，统一目标继承分支中的基础行为契约（尤其是 visitor 入口/出口与共享默认逻辑）。
- 降低继承链中的重复分支和“同类节点不同行为”的维护成本。
- 为后续重构提供更稳定的回归基线（行为、性能、内存）。
- 增补聚焦回归，覆盖继承层次敏感路径。

**Non-Goals:**
- 不引入新的 SQL 语法能力，不做方言扩展。
- 不进行大规模 AST 结构改名或公开 API 语义变更。
- 不追求一次性清理全部历史继承问题，仅覆盖本次锁定分支。

## Decisions

### Decision 1: 兼容优先的“父类契约收敛”
- **Choice:** 在父类或共享抽象层定义统一的默认行为入口，并让目标子类显式复用该入口。
- **Why:** 可在最小改动范围内消除重复逻辑，同时保留现有调用面。
- **Alternative considered:** 直接重写为全新层次结构；风险高、回归面过大，暂不采用。

### Decision 2: 访问分发行为保持不变量
- **Choice:** 将“可接受/可拒绝边界、token 推进、遍历顺序”视作不变量，仅优化层次内部组织。
- **Why:** 下游测试与外部使用对这些行为有隐式依赖。
- **Alternative considered:** 顺带修复局部行为差异；会混入语义变更，难以归因。

### Decision 3: 以聚焦回归 + 全量闸门验证
- **Choice:** 先运行继承层次敏感测试，再执行 `mvn -pl core test`，并记录性能/内存对比。
- **Why:** 兼顾迭代速度与发布级信心。
- **Alternative considered:** 仅全量测试；反馈慢且定位成本更高。

## Risks / Trade-offs

- [Risk] 某些历史测试对具体调用路径耦合较深，可能在重构后出现脆弱失败。  
  -> Mitigation: 优先断言行为结果与关键上下文，而非过度绑定内部实现细节。

- [Risk] 继承收敛可能意外影响多方言 visitor 分支。  
  -> Mitigation: 增加跨方言最小回归样例并执行核心模块全量测试。

- [Trade-off] 小步收敛意味着会保留部分历史不一致。  
  -> Mitigation: 在本次完成后整理后续候选分支，分批推进。

## Migration Plan

1. 识别并记录目标继承分支中的重复/分叉行为点。  
2. 在 `core` 内做局部、可回滚的契约收敛改造。  
3. 补充继承敏感回归测试并执行聚焦验证。  
4. 执行 `mvn -pl core test`，并记录性能/内存基线对比。  
5. 若出现行为回归，按分支级别回退并缩小范围重试。

## Open Questions

- 是否需要在后续变更中沉淀一份 AST 继承层次的统一约束指南？  
- 是否将继承层次敏感回归拆分为独立测试分组以便持续执行？
