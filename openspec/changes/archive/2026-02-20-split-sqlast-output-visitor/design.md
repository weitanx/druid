## Context

`SQLASTOutputVisitor` 当前聚合了大量节点输出分支和方言差异处理，单文件规模较大，理解与修改成本高。该类在格式化、参数化与方言输出路径中处于核心位置，任何改动都可能引入输出回归，因此需要在“可维护性提升”和“行为不变”之间建立明确边界。

## Goals / Non-Goals

**Goals:**
- 将 `SQLASTOutputVisitor` 按职责拆分为更小的实现单元，降低单点复杂度。
- 保持对外 API 与输出语义稳定，避免用户侧 SQL 文本行为变化。
- 固化拆分后的回归验证策略，覆盖通用与方言关键路径。
- 让后续新增语法节点时只需修改局部输出单元，减少全局耦合。

**Non-Goals:**
- 不引入新的公共 visitor API。
- 不改变 AST 结构或 parser 行为。
- 不引入外部依赖或跨模块架构变更。

## Decisions

### Decision 1: 以“职责分区 + 主 visitor 协调”方式拆分

- 备选 A：继续在单类中按 region 分段维护  
  - 优点：改动小  
  - 缺点：结构性复杂度继续增长
- 备选 B（采用）：拆出若干内部协作单元（按 DDL/DML/表达式或通用/方言职责），主 visitor 仅负责调度  
  - 优点：边界清晰、可测试性更好  
  - 缺点：需要梳理共享状态传递规则

### Decision 2: 优先保持行为兼容，再做结构重排

- 先保持输出 token 顺序、空格和换行语义一致，再进行方法迁移。
- 对高风险分支使用“迁移前后快照对比”验证，避免隐式格式漂移。

### Decision 3: 保持现有共享状态模型，但显式化访问边界

- 不重构全量上下文对象，先沿用现有字段与访问方式。
- 在拆分单元中限制可见接口，避免新增跨单元隐式写入。

## Risks / Trade-offs

- [风险] 拆分后输出顺序细微变化导致回归  
  → [缓解] 增加语句级输出断言，覆盖典型 DDL/DML/查询与方言样例。
- [风险] 共享状态在不同单元间传递不完整  
  → [缓解] 在主 visitor 层统一状态入口，并增加边界单测。
- [取舍] 短期会增加文件数量和调用层次  
  → [原因] 换取长期可维护性和更小的变更影响面。

## Migration Plan

1. 识别 `SQLASTOutputVisitor` 的职责分区与迁移顺序。  
2. 引入拆分单元并由主 visitor 委派调用。  
3. 逐步迁移节点输出逻辑，保持每步可回归验证。  
4. 执行 parser/visitor 相关回归测试，确认输出行为等价。  
5. 若出现行为偏差，按迁移批次快速回滚到前一稳定点。

## Performance and Memory Validation Plan

- 基线：执行 `MySqlPerfTest` 与内存测试，记录结果。  
- 变更后：执行同样测试并对比。  
- 判定：无明显系统性退化，无新增内存泄漏信号。

## Open Questions

- 拆分颗粒度是否以“语句类型”优先，还是以“通用能力（缩进、参数化、关键字输出）”优先？
- 是否需要在当前迭代同时整理历史重复分支，还是先只做等价迁移？
