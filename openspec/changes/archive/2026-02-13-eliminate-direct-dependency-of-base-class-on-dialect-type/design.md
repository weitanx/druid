## Context

`SQLStatementParser` 当前在基础分发路径中包含对具体方言类型的直接分支判断，导致基类同时承担“通用语法框架”和“方言路由策略”两类职责。该结构在新增或调整方言时容易扩大改动范围，并让回归测试集中在基类热点区域。  
本次变更限定在 `core` 模块解析器内部，目标是在不改变外部调用 API 与默认解析结果的前提下，把方言选择职责下沉到注册机制与方言工厂边界。

## Goals / Non-Goals

**Goals:**
- 让基类不直接依赖具体方言类型分支，改为依赖统一的方言解析提供者抽象。
- 保持“已注册方言优先、未注册回退内建分发”的行为语义不变。
- 保证并发注册/查找/注销场景下解析器选择路径一致且无部分可见状态。
- 为后续新增方言提供低侵入扩展点，减少对基类改动。

**Non-Goals:**
- 不重写现有方言 parser 语法实现。
- 不引入新的外部依赖或跨模块改造。
- 不调整公开解析 API 的参数和返回类型。

## Decisions

### Decision 1: 基类通过抽象解析器提供者做方言分发

- **备选方案 A**：继续在基类中维护方言枚举分支  
  - 优点：实现简单，短期改动小  
  - 缺点：新增方言仍需改基类，耦合持续扩大
- **备选方案 B（采用）**：基类只调用统一提供者解析入口，具体方言映射由注册机制与内建工厂处理  
  - 优点：职责清晰，可测试性更好，扩展点稳定  
  - 缺点：需要梳理现有分发链路并补回归测试

### Decision 2: 保持双阶段解析策略的兼容语义

- 第一阶段优先查找注册方言提供者。
- 第二阶段在未命中时回退到既有内建 `DbType` 分发路径。
- 该决策保证现有用户在不注册新方言时行为不变。

### Decision 3: 并发安全继续由注册表原子操作保障

- 复用当前注册表并发容器与原子替换语义，不在基类引入额外锁。
- 基类仅消费“已解析完成的提供者结果”，避免读取半更新状态。

## Risks / Trade-offs

- [风险] 分发链重排后出现某些方言分支漏接入  
  → [缓解] 增加“已注册/未注册/注销后”三类路径测试，并覆盖典型方言。
- [风险] 旧代码隐式依赖基类中的分支顺序  
  → [缓解] 在 delta spec 明确优先级规则并用回归用例固定行为。
- [取舍] 为解耦增加了一层抽象调用  
  → [原因] 换取后续方言扩展时更小的改动面和更稳定的核心代码。

## Migration Plan

1. 在 `core` 中引入/收敛统一方言提供者分发入口。  
2. 将基类中的直接方言判断替换为提供者调用。  
3. 保留未注册场景回退到内建 `DbType` 分发。  
4. 增加/更新单元测试与 BVT 用例，确认行为等价。  
5. 若回归失败，按开关或提交粒度回滚到原分发路径（不涉及数据迁移）。

## Performance and Memory Validation Plan

- 基线前测：执行 `MySqlPerfTest` 与内存占用测试，记录吞吐/延迟/分配量。  
- 改造后复测：执行同一组测试与参数。  
- 验收标准：解析吞吐与延迟波动在可接受范围内（无系统性退化），无新增内存泄漏信号。

## Open Questions

- 当前是否已有统一的“方言提供者工厂”可直接复用，还是需要在现有注册入口上增加轻量适配层？
- 是否需要为第三方扩展方言提供额外的诊断日志（例如命中注册提供者或回退路径）？
